<div class="layuimini-container">
    <div class="layuimini-main">

        <fieldset id="" class="table-search-fieldset " style="margin-bottom: 1%">
            <legend>未结算提现统计</legend>
            <table class="table layui-table " >
                <thead>
                <tr>
                    <th style="text-align: center;">未结算笔数</th>
                    <th style="text-align: center;">未结算金额</th>
                    <th style="text-align: center;">今日申请</th>
                    <th style="text-align: center;">今日金额</th>
                </tr>
                </thead>
                <tbody>
                <tr class="text-center">
                    <td>{$dpayCount}</td>
                    <td>￥{$dpayMonet}</td>
                    <td>0</td>
                    <td>￥0.00</td>
                </tr>
                </tbody>
            </table>
        </fieldset>

        <table id="currentTable" class="layui-table layui-hide"
               data-auth-add="{:auth('outlayw/add')}"
               data-auth-edit="{:auth('outlayw/edit')}"
               data-auth-delete="{:auth('outlayw/delete')}"
               data-auth-approve="{:auth('outlayw/approve')}"
               data-auth-reject="{:auth('outlayw/reject')}"
               lay-filter="currentTable">
        </table>

    </div>
</div>

<script>
    layui.use(['table', 'form', 'layer'], function () {
        var $ = layui.jquery,
            table = layui.table,
            form = layui.form,
            layer = layui.layer;

        table.render({
            elem: '#currentTable',
            url: '{:url("index")}',
            toolbar: '#toolbarDemo',
            defaultToolbar: ['filter', 'exports', 'print'],
            cols: [[
                {type: "checkbox", width: 50},
                {field: 'id', width: 80, title: 'ID', sort: true},
                {field: 'admin_id', width: 100, title: '用户ID'},
                {field: 'admins.username', width: 120, title: '用户名'},
                {field: 'money', width: 120, title: '提现金额', templet: function(d){
                    return '￥' + d.money;
                }},
                {field: 'account', width: 200, title: '收款账户'},
                {field: 'remark', width: 200, title: '备注'},
                {field: 'create_time', width: 180, title: '申请时间', templet: function(d){
                    return layui.util.toDateString(d.create_time * 1000, 'yyyy-MM-dd HH:mm:ss');
                }},
                {field: 'status', width: 100, title: '状态', templet: function(d){
                    var statusMap = {0: '未结算', 1: '已结算', 2: '已拒绝'};
                    var colorMap = {0: 'orange', 1: 'green', 2: 'red'};
                    return '<span style="color: ' + colorMap[d.status] + '">' + statusMap[d.status] + '</span>';
                }},
                {title: '操作', width: 200, templet: '#currentTableBar', fixed: "right", align: "center"}
            ]],
            limits: [10, 15, 20, 25, 50, 100],
            limit: 15,
            page: true,
            skin: 'line'
        });

        // 监听工具条
        table.on('tool(currentTable)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;

            if (layEvent === 'edit') {
                var index = layer.open({
                    title: '编辑未结算提现',
                    type: 2,
                    shade: 0.2,
                    maxmin:true,
                    shadeClose: true,
                    area: ['100%', '100%'],
                    content: '{:url("edit")}?id=' + data.id,
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
            } else if (layEvent === 'delete') {
                layer.confirm('真的删除这条记录吗？', function (index) {
                    $.post('{:url("delete")}', {id: data.id}, function (result) {
                        if (result.code === 1) {
                            obj.del();
                            layer.close(index);
                            layer.msg(result.msg, {icon: 1});
                        } else {
                            layer.msg(result.msg, {icon: 2});
                        }
                    });
                });
            } else if (layEvent === 'approve') {
                layer.confirm('确认结算这笔提现吗？', function (index) {
                    $.post('{:url("approve")}', {id: data.id}, function (result) {
                        if (result.code === 1) {
                            layer.close(index);
                            layer.msg(result.msg, {icon: 1});
                            table.reload('currentTable');
                        } else {
                            layer.msg(result.msg, {icon: 2});
                        }
                    });
                });
            } else if (layEvent === 'reject') {
                layer.prompt({title: '请输入拒绝原因', formType: 2}, function(text, index){
                    $.post('{:url("reject")}', {id: data.id, reason: text}, function (result) {
                        if (result.code === 1) {
                            layer.close(index);
                            layer.msg(result.msg, {icon: 1});
                            table.reload('currentTable');
                        } else {
                            layer.msg(result.msg, {icon: 2});
                        }
                    });
                });
            }
        });

    });
</script>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="refresh">
            <i class="fa fa-refresh"></i> 刷新
        </button>
    </div>
</script>

<script type="text/html" id="currentTableBar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="approve">结算</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="reject">拒绝</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
</script>
