<div class="layuimini-container">
    <div class="layuimini-main">

        <fieldset id="" class="table-search-fieldset " style="margin-bottom: 1%">
            <legend>下级管理统计</legend>
            <table class="table layui-table " >
                <thead>
                <tr>
                    <th style="text-align: center;">下级总数</th>
                    <th style="text-align: center;">已激活邀请码</th>
                    <th style="text-align: center;">激活率</th>
                    <th style="text-align: center;">今日激活</th>
                    <th style="text-align: center;">总订单数</th>
                    <th style="text-align: center;">总订单金额</th>
                </tr>
                </thead>
                <tbody>
                <tr class="text-center">
                    <td><?php echo isset($statistics['total']) ? $statistics['total'] : 0;?></td>
                    <td><?php echo isset($statistics['activated']) ? $statistics['activated'] : 0;?></td>
                    <td><?php echo isset($statistics['activation_rate']) ? $statistics['activation_rate'] : 0;?>%</td>
                    <td><?php echo isset($statistics['today_activated']) ? $statistics['today_activated'] : 0;?></td>
                    <td><?php echo isset($statistics['total_orders']) ? $statistics['total_orders'] : 0;?></td>
                    <td>￥<?php echo isset($statistics['total_amount']) ? $statistics['total_amount'] : '0.00';?></td>
                </tr>
                </tbody>
            </table>
        </fieldset>

        <blockquote class="layui-elem-quote"  style="margin-bottom: 15px">
            下级管理说明:
            <br>
            这里显示您推广的所有下级用户信息。
            <br>
            包括邀请码激活情况和订单统计。
            <br>
            邀请码收费为: <span style="color:  red">{:sysconfig('jg','jg_yqm')}</span> 元/个。
            <br>
            总营业额达: <span style="color:  red">{:sysconfig('jg','jg_yqm')}</span> 元的代理可以售卖。
        </blockquote>

        <table id="currentTable" class="layui-table layui-hide"
               data-auth-add="{:auth('number/add')}"
               data-auth-edit="{:auth('number/edit')}"
               data-auth-delete="{:auth('number/delete')}"
               lay-filter="currentTable">
        </table>
    </div>
</div>

<script>
layui.use(['table', 'form'], function () {
    var $ = layui.jquery,
        table = layui.table,
        form = layui.form;

    table.render({
        elem: '#currentTable',
        url: '{:url("number/getList")}',
        where: {type: 'subordinate'},
        toolbar: '#toolbarDemo',
        defaultToolbar: ['filter', 'exports', 'print'],
        cols: [[
            {type: "checkbox", width: 50},
            {field: 'id', width: 80, title: 'ID', sort: true},
            {field: 'number', width: 150, title: '邀请码'},
            {field: 'admin', width: 120, title: '生成用户', templet: function(d){
                return d.admin ? d.admin.username : '-';
            }},
            {field: 'admin_ua', width: 120, title: '激活用户', templet: function(d){
                return d.admin_ua ? d.admin_ua.username : '-';
            }},
            {field: 'status', width: 100, title: '状态', templet: function(d){
                if (d.status == 1) {
                    return '<span class="layui-badge layui-bg-green">已激活</span>';
                } else {
                    return '<span class="layui-badge layui-bg-orange">未激活</span>';
                }
            }},
            {field: 'create_time_formatted', width: 160, title: '生成时间'},
            {field: 'activate_time_formatted', width: 160, title: '激活时间'},
            {field: 'order_stats', width: 200, title: '订单统计', templet: function(d){
                if (d.order_stats) {
                    return '订单: ' + d.order_stats.total_orders + '笔<br>金额: ￥' + d.order_stats.total_amount;
                }
                return '-';
            }},
            {title: '操作', width: 150, templet: '#currentTableBar', fixed: "right", align: "center"}
        ]],
        limits: [10, 15, 20, 25, 50, 100],
        limit: 15,
        page: true
    });

    // 监听工具条
    table.on('tool(currentTable)', function (obj) {
        var data = obj.data;
        if (obj.event === 'detail') {
            layer.open({
                type: 1,
                title: '下级详情',
                content: '<div style="padding: 20px;">' +
                    '<p><strong>邀请码:</strong> ' + data.number + '</p>' +
                    '<p><strong>生成用户:</strong> ' + (data.admin ? data.admin.username : '-') + '</p>' +
                    '<p><strong>激活用户:</strong> ' + (data.admin_ua ? data.admin_ua.username : '-') + '</p>' +
                    '<p><strong>状态:</strong> ' + (data.status == 1 ? '已激活' : '未激活') + '</p>' +
                    '<p><strong>生成时间:</strong> ' + data.create_time_formatted + '</p>' +
                    '<p><strong>激活时间:</strong> ' + data.activate_time_formatted + '</p>' +
                    (data.order_stats ? '<p><strong>订单统计:</strong> ' + data.order_stats.total_orders + '笔，￥' + data.order_stats.total_amount + '</p>' : '') +
                    '</div>',
                area: ['500px', '400px']
            });
        } else if (obj.event === 'orderStats') {
            if (data.ua) {
                $.get('{:url("number/getSubordinateOrderStats")}', {uid: data.ua}, function(result) {
                    if (result.code === 0) {
                        var stats = result.data;
                        layer.open({
                            type: 1,
                            title: '订单统计详情',
                            content: '<div style="padding: 20px;">' +
                                '<p><strong>总订单数:</strong> ' + stats.total_orders + '笔</p>' +
                                '<p><strong>总订单金额:</strong> ￥' + stats.total_amount + '</p>' +
                                '<p><strong>今日订单数:</strong> ' + stats.today_orders + '笔</p>' +
                                '<p><strong>今日订单金额:</strong> ￥' + stats.today_amount + '</p>' +
                                '</div>',
                            area: ['400px', '300px']
                        });
                    }
                });
            } else {
                layer.msg('该邀请码尚未激活', {icon: 0});
            }
        }
    });
});
</script>

<script type="text/html" id="currentTableBar">
    <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
    {{# if (d.status == 1) { }}
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="orderStats">订单统计</a>
    {{# } }}
</script>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="refresh">刷新数据</button>
        <button class="layui-btn layui-btn-sm" lay-event="export">导出数据</button>
    </div>
</script>
